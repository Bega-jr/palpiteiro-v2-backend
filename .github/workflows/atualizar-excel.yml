name: Atualizar Excel da Caixa

on:
  schedule:
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  atualizar:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Instalar dependências
        run: pip install requests pandas openpyxl

      - name: Baixar e processar dados da Lotofácil via API
        run: |
          # Acessar dados via API é mais estável e evita o erro 429 do download direto.
          # Esta API gratuita retorna o último resultado da Lotofácil em JSON.
          
          # Salva o script Python que baixa e processa os dados
          cat << 'EOF' > download_lotofacil_data.py
import requests
import json
import pandas as pd
import os

# API gratuita e estável para resultados de loterias da Caixa
# Fonte: https://loteriascaixa-api.herokuapp.com/
API_URL = "https://loteriascaixa-api.herokuapp.com/api/lotofacil/latest"
OUTPUT_FILE = "Lotofácil.xlsx"

print(f"Buscando dados da Lotofácil na API: {API_URL}")

try:
    # A API retorna o último resultado da Lotofácil em formato JSON
    response = requests.get(API_URL, timeout=15)
    response.raise_for_status()  # Levanta exceção para erros HTTP (4xx ou 5xx)
    
    data = response.json()
    
    # Estrutura os dados para salvar no Excel
    # O objetivo é replicar a informação que o usuário obteria no Excel,
    # mas de forma mais confiável via API.
    
    # Cria um DataFrame com os dados principais
    df_data = {
        "Concurso": [data.get("concurso")],
        "Data Sorteio": [data.get("data")],
        "Dezenas Sorteadas": [", ".join(map(str, data.get("dezenas")))],
        "Local Sorteio": [data.get("local")],
        "Ganhadores 15 Acertos": [data.get("premiacao", {}).get("15 Acertos", {}).get("ganhadores")],
        "Valor 15 Acertos": [data.get("premiacao", {}).get("15 Acertos", {}).get("valorDoPremio")],
        "Ganhadores 14 Acertos": [data.get("premiacao", {}).get("14 Acertos", {}).get("ganhadores")],
        "Valor 14 Acertos": [data.get("premiacao", {}).get("14 Acertos", {}).get("valorDoPremio")],
        "Acumulado": [data.get("acumulado")],
        "Valor Acumulado": [data.get("valorAcumulado")],
        "Proximo Concurso": [data.get("proximoConcurso")],
        "Data Proximo Concurso": [data.get("dataProximoConcurso")],
    }
    
    df = pd.DataFrame(df_data)
    
    # Salva o DataFrame em um arquivo Excel
    df.to_excel(OUTPUT_FILE, index=False)
    
    print(f"Dados do concurso {data.get('concurso')} salvos com sucesso em {OUTPUT_FILE}")
    print(f"Tamanho do arquivo: {os.path.getsize(OUTPUT_FILE)} bytes")

except requests.exceptions.RequestException as e:
    print(f"Erro ao acessar a API: {e}")
    exit(1)
except Exception as e:
    print(f"Ocorreu um erro inesperado: {e}")
    exit(1)
EOF
          
          # Executa o script Python
          python download_lotofacil_data.py

      - name: Commit e push
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add Lotofácil.xlsx
          git commit -m "Atualização automática do Excel - $(date '+%d/%m/%Y às %H:%M')" || echo "Nada pra commitar"
          git push origin main --force-with-lease

      - name: Trigger Vercel Deploy
        run: curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
